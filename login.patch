From 4315d524be9ae7744411d1ea86c32e3d193c25d8 Mon Sep 17 00:00:00 2001
From: Sean Schofield <schof@apache.org>
Date: Fri, 30 May 2008 19:27:10 -0400
Subject: [PATCH] Require login or user creation before checkout.

---
 app/controllers/checkout_controller.rb |    7 +++++++
 app/controllers/users_controller.rb    |    9 +++++++++
 2 files changed, 16 insertions(+), 0 deletions(-)

diff --git a/app/controllers/checkout_controller.rb b/app/controllers/checkout_controller.rb
index 8a04824..54a4a00 100644
--- a/app/controllers/checkout_controller.rb
+++ b/app/controllers/checkout_controller.rb
@@ -1,4 +1,5 @@
 class CheckoutController < Spree::BaseController
+  before_filter :new_or_login
   before_filter :find_order, :except => [:index, :thank_you]
     
   def index
@@ -141,6 +142,12 @@ class CheckoutController < Spree::BaseController
           @order
         end
       end
+      
+      def new_or_login
+        # create a new user (or login an existing one)
+        return if logged_in?
+        redirect_to new_user_url
+      end
 
       def finalize_order
         Order.transaction do
diff --git a/app/controllers/users_controller.rb b/app/controllers/users_controller.rb
index b5c5cf6..968e630 100644
--- a/app/controllers/users_controller.rb
+++ b/app/controllers/users_controller.rb
@@ -2,4 +2,13 @@ class UsersController < Spree::BaseController
   create.before do
     @user.login = @user.email 
   end
+
+  create.after do
+    #User.authenticate(@user.login, @user.password)    
+    self.current_user = @user       
+  end
+
+  create.response do |wants|  
+    wants.html {redirect_to :controller => :checkout, :action => :addresses}         
+  end
 end
\ No newline at end of file
-- 
1.5.4.950.ga176

